# -*- coding: utf-8 -*-
"""Fix corrupted encoding in feishu_service.py"""

with open('app/services/feishu_service.py', 'rb') as f:
    raw = f.read()

text = raw.decode('utf-8', errors='replace')

# All known corrupted patterns -> corrections
replacements = [
    # Comments
    ('# æž„é€ è¯·ï¿½?', '# æž„é€ è¯·æ±‚'),
    ('# å‘é€è¯·ï¿½?', '# å‘é€è¯·æ±‚'),
    ('æ˜¯ä¸€ï¿½?streamï¼Œéœ€è¦è¯»ï¿½?', 'æ˜¯ä¸€ä¸ªstreamï¼Œéœ€è¦è¯»å–'),
    ('lark-oapi ï¿½?response.file æ‰æ˜¯æ–‡ä»¶ï¿½?', 'lark-oapi çš„ response.file æ‰æ˜¯æ–‡ä»¶æµ'),
    ('æŸäº›ç‰ˆæœ¬å¯èƒ½ï¿½?response.data', 'æŸäº›ç‰ˆæœ¬å¯èƒ½ç”¨ response.data'),
    ('å‘é€é£žä¹¦å¡ç‰‡æ¶ˆï¿½?', 'å‘é€é£žä¹¦å¡ç‰‡æ¶ˆæ¯'),
    ('lark-oapi ï¿½?update æŽ¥å£é€šå¸¸ï¿½?patch', 'lark-oapi çš„ update æŽ¥å£é€šå¸¸æ˜¯ patch'),
    ('å‘é€å›¾ç‰‡æ¨¡å¼åˆ‡æ¢æˆåŠŸå¡ï¿½?', 'å‘é€å›¾ç‰‡æ¨¡å¼åˆ‡æ¢æˆåŠŸå¡ç‰‡'),
    ('å‘é€å…³é”®è¯æ£€ç´¢æ¨¡å¼åˆ‡æ¢æˆåŠŸå¡ï¿½?', 'å‘é€å…³é”®è¯æ£€ç´¢æ¨¡å¼åˆ‡æ¢æˆåŠŸå¡ç‰‡'),
    ('å‘é€ä¼˜åŒ–ç»“æžœå¡ï¿½?(éžæµå¼ï¼Œå…¼å®¹æ—§æŽ¥ï¿½?', 'å‘é€ä¼˜åŒ–ç»“æžœå¡ç‰‡(éžæµå¼ï¼Œå…¼å®¹æ—§æŽ¥å£)'),
    ('å¯èƒ½å­˜åœ¨ï¿½?markdown ä»£ç å—æ ‡ï¿½?', 'å¯èƒ½å­˜åœ¨çš„ markdown ä»£ç å—æ ‡è®°'),
    ('æ—¥æœŸèŒƒå›´æè¿°ï¼ˆå¦‚ \"2026-02-09 ï¿½?2026-02-12 (æœ¬å‘¨)\"ï¿½?', 'æ—¥æœŸèŒƒå›´æè¿°ï¼ˆå¦‚ \"2026-02-09 è‡³ 2026-02-12 (æœ¬å‘¨)\"ï¼‰'),
    (':return: message_id ï¿½?None', ':return: message_id æˆ– None'),
    ('å‘é€é£žä¹¦æ–‡æœ¬æ¶ˆï¿½?', 'å‘é€é£žä¹¦æ–‡æœ¬æ¶ˆæ¯'),
    ('å‘é€å›¾ç‰‡åˆ†æžæµå¼å¼€å§‹å¡ï¿½?', 'å‘é€å›¾ç‰‡åˆ†æžæµå¼å¼€å§‹å¡ç‰‡'),
    ('å‘é€æ¾„æ¸…é—®é¢˜å¡ï¿½?', 'å‘é€æ¾„æ¸…é—®é¢˜å¡ç‰‡'),
    
    # Card content strings
    ('\"ï¿½?å·²åˆ‡æ¢è‡³åŸºç¡€æ¨¡å¼\"', '\"âœ¨ å·²åˆ‡æ¢è‡³åŸºç¡€æ¨¡å¼\"'),
    ('æ‚¨çŽ°åœ¨å¤„ï¿½?*åŸºç¡€æ¨¡å¼**', 'æ‚¨çŽ°åœ¨å¤„äºŽ**åŸºç¡€æ¨¡å¼**'),
    ('æˆ‘å°†ä¸ºæ‚¨ä¼˜åŒ–ï¿½?', 'æˆ‘å°†ä¸ºæ‚¨ä¼˜åŒ–ã€‚"'),
    ('\"ðŸ–¼ï¿½?å·²åˆ‡æ¢è‡³å›¾ç‰‡æ¨¡å¼\"', '\"ðŸ–¼ï¸ å·²åˆ‡æ¢è‡³å›¾ç‰‡æ¨¡å¼\"'),
    ('æ‚¨çŽ°åœ¨å¤„ï¿½?*å›¾ç‰‡æ¨¡å¼**', 'æ‚¨çŽ°åœ¨å¤„äºŽ**å›¾ç‰‡æ¨¡å¼**'),
    ('è¯·å‘é€å›¾ç‰‡æˆ–è¯¦ç»†çš„ç”»é¢æè¿°ï¿½?', 'è¯·å‘é€å›¾ç‰‡æˆ–è¯¦ç»†çš„ç”»é¢æè¿°ã€‚"'),
    ('å·²åˆ‡æ¢è‡³å…³é”®è¯æ£€ç´¢æ¨¡ï¿½?', 'å·²åˆ‡æ¢è‡³å…³é”®è¯æ£€ç´¢æ¨¡å¼'),
    ('æ‚¨çŽ°åœ¨å¤„ï¿½?*å…³é”®è¯æ£€ç´¢æ¨¡ï¿½?*', 'æ‚¨çŽ°åœ¨å¤„äºŽ**å…³é”®è¯æ£€ç´¢æ¨¡å¼**'),
    ('è¯¥åŠŸèƒ½æš‚æœªå®žçŽ°ï¼Œæ•¬è¯·æœŸå¾…ï¿½?*', 'è¯¥åŠŸèƒ½æš‚æœªå®žçŽ°ï¼Œæ•¬è¯·æœŸå¾…ï¼**'),
    ('æ‚¨çŽ°åœ¨å¤„ï¿½?*æ—¥æŠ¥å‘¨æŠ¥æ€»ç»“æ¨¡å¼**', 'æ‚¨çŽ°åœ¨å¤„äºŽ**æ—¥æŠ¥å‘¨æŠ¥æ€»ç»“æ¨¡å¼**'),
    ('å‘é€å·¥ä½œå†…ï¿½?*', 'å‘é€å·¥ä½œå†…å®¹**'),
    ('æ—¥æŠ¥è¶Šä¸“ï¿½?}', 'æ—¥æŠ¥è¶Šä¸“ä¸š\"}'),
    
    # Optimization result card
    ('\"ï¿½?æç¤ºè¯ä¼˜åŒ–å®Œï¿½?', '\"âœ… æç¤ºè¯ä¼˜åŒ–å®Œæˆ\"'),
    ('\"ï¿½?åŽŸå§‹æç¤ºï¿½?*', '\"âœ¨ åŽŸå§‹æç¤ºè¯**'),
    ('\"ï¿½?ä¼˜åŒ–ç»“æžœ**', '\"âœ¨ ä¼˜åŒ–ç»“æžœ**'),
    ('**åŽŸå§‹æç¤ºï¿½?*', '**åŽŸå§‹æç¤ºè¯**'),
    ('\"ï¿½?æç¤ºè¯ä¼˜åŒ–å®Œï¿½?', '\"âœ… æç¤ºè¯ä¼˜åŒ–å®Œæˆ\"'),
    ('å¯èƒ½å­˜åœ¨ï¿½?markdown ä»£ç å—æ ‡è®°ï¼Œä»¥ä¾¿åœ¨é£žä¹¦ä¸­ç›´æŽ¥æ¸²æŸ“', 'å¯èƒ½å­˜åœ¨çš„ markdown ä»£ç å—æ ‡è®°ï¼Œä»¥ä¾¿åœ¨é£žä¹¦ä¸­ç›´æŽ¥æ¸²æŸ“'),
    
    # Clarification card  
    ('éœ€è¦æ‚¨è¡¥å……ä¸€ç‚¹ç»†ï¿½?', 'éœ€è¦æ‚¨è¡¥å……ä¸€ç‚¹ç»†èŠ‚'),
    ('æˆ‘ä¼šç»“åˆæ‚¨çš„å›žç­”è¿›è¡Œæœ€ç»ˆä¼˜ï¿½?}', 'æˆ‘ä¼šç»“åˆæ‚¨çš„å›žç­”è¿›è¡Œæœ€ç»ˆä¼˜åŒ–\"}'),
    
    # Image analysis card
    ('\"ðŸ–¼ï¿½?æ­£åœ¨åˆ†æžç”»é¢...\"', '\"ðŸ–¼ï¸ æ­£åœ¨åˆ†æžç”»é¢...\"'),
    ('ç”Ÿæˆç”»é¢æ‘˜ï¿½?..', 'ç”Ÿæˆç”»é¢æ‘˜è¦..'),
    ('\"ï¿½?å›¾ç‰‡åˆ†æžå®Œæˆ\"', '\"âœ… å›¾ç‰‡åˆ†æžå®Œæˆ\"'),
    ('æˆ‘å°†ç»“åˆç”»é¢ä¿¡æ¯ä¸ºæ‚¨ä¼˜åŒ–ï¿½?*', 'æˆ‘å°†ç»“åˆç”»é¢ä¿¡æ¯ä¸ºæ‚¨ä¼˜åŒ–ï¼**'),
    
    # Weekly summary card
    ('è¯·ç¨ï¿½?..', 'è¯·ç¨å€™..'),
    ('\"ï¿½?å‘¨åº¦é€’å½’è¿›æ­¥æ€»ç»“å®Œæˆ\"', '\"âœ… å‘¨åº¦é€’å½’è¿›æ­¥æ€»ç»“å®Œæˆ\"'),
    
    # Apply the card text update we originally intended
    ('3. **å‘¨åº¦é€’å½’æ€»ç»“**ï¼ˆå‘é€\u201cå‘¨æ€»ç»“\u201dæˆ–\u201cä¸Šå‘¨æ€»ç»“\u201dï¼‰ï¼Œåˆ†æžä¸€å‘¨è®¡åˆ’å®Œæˆåº¦å¹¶è¯„åˆ†ã€‚', 
     '3. **ç”Ÿæˆæ€»ç»“æŠ¥å‘Š**ï¼Œç¤ºä¾‹ï¼š\\n   - ðŸ“… æ—¥æ€»ç»“ï¼š\u201c02-09æ€»ç»“\u201dã€\u201cæ˜¨å¤©æ€»ç»“\u201d\\n   - ðŸ“Š å‘¨æ€»ç»“ï¼š\u201cæœ¬å‘¨æ€»ç»“\u201dã€\u201cä¸Šå‘¨æ€»ç»“\u201d\\n   - ðŸ“ˆ æœˆæ€»ç»“ï¼š\u201c1æœˆæ€»ç»“\u201dã€\u201cä¸Šæœˆæ€»ç»“\u201d'),
]

for old, new in replacements:
    if old in text:
        text = text.replace(old, new)
        print(f'Fixed: {old[:40]}...')

# Check remaining ?
remaining = text.count('\ufffd')
print(f'\nRemaining replacement chars: {remaining}')
if remaining > 0:
    import re
    for m in re.finditer('\ufffd', text):
        s = m.start()
        ctx = text[max(0,s-10):s+10]
        print(f'  Remaining at pos {s}: ...{repr(ctx)}...')

# Write back as UTF-8
with open('app/services/feishu_service.py', 'w', encoding='utf-8', newline='\r\n') as f:
    f.write(text)

print('\nDone! File saved.')
